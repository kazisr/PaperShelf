<div style="border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #ffffff; overflow: hidden; border: 1px solid #e5e7eb; display: flex; flex-direction: column; height: 100%;" data-paper-card>
  <div style="aspect-ratio: 3 / 2; background: #f9fafb; display: flex; align-items: center; justify-content: center;">
    {% if paper.thumb_path %}
      <img
        src="/media/{{ paper.thumb_path }}"
        alt="{{ paper.title }}"
        loading="lazy"
        style="width: 100%; height: 100%; object-fit: cover; display: block;"
      />
    {% else %}
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 64px; height: 64px; opacity: 0.4;">
        <path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm7 1.5V8h4.5L13 3.5z"/>
      </svg>
    {% endif %}
  </div>

  <div style="padding: 16px; display: flex; flex-direction: column; flex: 1 1 auto; gap: 8px;">
    <h3 style="font-size: 1rem; font-weight: 600; line-height: 1.4; margin: 0;">{{ paper.title }}</h3>

    <div style="margin-top: 4px; font-size: 0.875rem; color: #4b5563;">
      {% set authors = paper.authors or [] %}
      {% if authors|length > 0 %}
        <span>{{ authors|join(', ') }}</span>
      {% else %}
        <span style="opacity: 0.6;">Unknown author</span>
      {% endif %}
      {% if paper.year %}
        <span style="margin-left: 8px; padding: 2px 6px; border-radius: 4px; background: #f3f4f6; color: #374151; font-size: 0.75rem; vertical-align: middle;">{{ paper.year }}</span>
      {% endif %}
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; font-size: 0.75rem;">
      {% if paper.venue %}
        <span style="padding: 2px 8px; border-radius: 4px; background: #f3f4f6; color: #374151;">{{ paper.venue }}</span>
      {% endif %}
      {% if paper.doi %}
        <a href="https://doi.org/{{ paper.doi }}" target="_blank"
           style="padding: 2px 8px; border-radius: 4px; background: #e0e7ff; color: #3730a3; text-decoration: none;">
          DOI
        </a>
      {% endif %}
      {% if paper.arxiv_id %}
        <a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" target="_blank"
           style="padding: 2px 8px; border-radius: 4px; background: #ffe4e6; color: #881337; text-decoration: none;">
          arXiv
        </a>
      {% endif %}
    </div>

    {% if paper.abstract %}
      <p style="margin-top: 12px; font-size: 0.875rem; color: #374151;" data-abstract>
        <!-- Collapsed (3-line clamp) -->
        <span data-short style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">{{ paper.abstract }}</span>
        <!-- Expanded (hidden by default) -->
        <span data-full style="display: none;">{{ paper.abstract }}</span>

        <!-- Toggle button -->
        <button type="button" data-toggle
          aria-expanded="false"
          style="margin-left: 8px; color: #2563eb; background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 0.875rem;">
          Read more
        </button>
      </p>
    {% endif %}

    <div style="margin-top: auto; display: flex; justify-content: flex-end; align-items: flex-end; gap: 8px;">
      <a href="{{ paper.url or ('/media/' + paper.path) }}" target="_blank"
         style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 8px; background: #2563eb; color: #ffffff; text-decoration: none; font-size: 0.875rem;">
        Open
      </a>
      <a href="/media/{{ paper.path }}" download
         style="display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 8px; background: #e5e7eb; color: #111827; text-decoration: none; font-size: 0.875rem;">
        Download
      </a>
    </div>
  </div>
</div>

<!-- Robust inline JS: waits for DOM ready and handles dynamically added cards -->
<script>
(function () {
  function initOne(container) {
    if (!container || container.__abstractInit) return;
    container.__abstractInit = true;

    var shortEl = container.querySelector('[data-short]');
    var fullEl  = container.querySelector('[data-full]');
    var btn     = container.querySelector('[data-toggle]');
    if (!shortEl || !fullEl || !btn) return;

    btn.addEventListener('click', function () {
      var expanded = btn.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        // Collapse
        fullEl.style.display  = 'none';
        shortEl.style.display = '-webkit-box';
        shortEl.style.webkitLineClamp = '3';
        shortEl.style.webkitBoxOrient = 'vertical';
        shortEl.style.overflow = 'hidden';
        btn.textContent = 'Read more';
        btn.setAttribute('aria-expanded', 'false');
      } else {
        // Expand
        fullEl.style.display  = 'inline';
        shortEl.style.display = 'none';
        btn.textContent = 'Show less';
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  }

  function initAll(root) {
    (root || document).querySelectorAll('[data-abstract]').forEach(initOne);
  }

  // Ensure it runs after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () { initAll(document); });
  } else {
    initAll(document);
  }

  // Also handle cards injected later (SPA / HTMX / Turbo / Alpine, etc.)
  var mo = new MutationObserver(function (mutations) {
    mutations.forEach(function (m) {
      m.addedNodes.forEach(function (node) {
        if (!(node instanceof Element)) return;
        if (node.matches && node.matches('[data-abstract]')) initOne(node);
        node.querySelectorAll && node.querySelectorAll('[data-abstract]').forEach(initOne);
      });
    });
  });
  mo.observe(document.documentElement || document.body, { childList: true, subtree: true });
})();
</script>
