{% extends "base.html" %}
{% block content %}
<div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border border-gray-100">

  <form method="get" class="flex gap-3 mb-4">
    <div class="relative flex-1">
      <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        name="q"
        value="{{ q }}"
        placeholder="Search by title or abstract..."
        class="w-full border border-gray-300 rounded-xl px-10 py-3 text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
        oninput="liveSearch(this.value)"
      />
    </div>
  </form>

  <div class="flex items-center justify-between flex-wrap gap-4">

    <div class="flex items-center gap-3">
      <label class="px-4 py-2 rounded-xl text-white font-medium cursor-pointer bg-blue-600 hover:bg-blue-700 shadow-md transition duration-150 ease-in-out">
        Select Folder ðŸ“‚
        <input id="folderPicker" type="file" webkitdirectory directory multiple hidden />
      </label>

      <div id="progressWrap" class="hidden min-w-[260px] ml-4">
        <div class="text-sm text-gray-600 mb-1">
          <span id="progressText">Preparingâ€¦</span>
        </div>
        <div class="w-64 bg-gray-200 rounded-full h-2 overflow-hidden shadow-inner">
          <div id="progressBar" class="h-2 bg-blue-600 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <form method="post" action="/dev/clean" class="shrink-0">
      <button class="px-4 py-2 rounded-xl border border-red-500 text-red-600 hover:bg-red-50 font-medium transition duration-150 ease-in-out">
        ðŸ§¹ Clean DB & Files (Dev)
      </button>
    </form>
  </div>
</div>

<div id="drop" x-data
     @dragover.prevent.delay.100="$el.classList.add('bg-blue-50', 'border-blue-500')"
     @dragleave.prevent.delay.100="$el.classList.remove('bg-blue-50', 'border-blue-500')"
     @drop.prevent="
       $el.classList.remove('bg-blue-50', 'border-blue-500');
       const files = $event.dataTransfer.files;
       for (const f of files) {
         if (!f.name.toLowerCase().endsWith('.pdf')) continue;
         const fd = new FormData();
         fd.append('file', f);
         fetch('/upload', { method:'POST', body:fd })
           .then(() => refreshCards());
       }
     "
     class="mb-6 p-6 text-center border-4 border-dashed rounded-2xl border-gray-300 bg-gray-50 text-lg text-gray-500 transition duration-200 ease-in-out">
  Drag & drop **PDF(s)** here to add ðŸ“¥
</div>

<!-- keep your hidden template (unused now, but harmless) -->
<div id="card-template" class="hidden">
  <div class="group bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col h-full">
    <div class="relative h-48 bg-gray-100 flex items-center justify-center overflow-hidden">
      <img class="thumb-img w-full h-full object-cover" alt="thumbnail" src="/static/no_thumb.png" />
      <a class="chip-open absolute top-3 right-3 inline-flex items-center gap-1 rounded-full bg-white/95 backdrop-blur-sm px-3 py-1 text-xs font-semibold text-blue-700 ring-1 ring-blue-100 hover:bg-white shadow-md transition" target="_blank">Open Full Text</a>
    </div>
    <div class="p-5 flex flex-col gap-2 flex-grow">
      <a class="card-title text-lg font-extrabold text-gray-900 leading-snug hover:text-blue-600 transition line-clamp-2" target="_blank">Untitled Paper Title</a>

      <div class="flex items-center gap-2 text-xs font-medium">
        <span class="year-badge inline-flex items-center rounded-full bg-blue-100 text-blue-700 px-3 py-1 shadow-sm">â€”</span>
        <span class="src-badge inline-flex items-center rounded-full bg-gray-100 text-gray-600 px-3 py-1 shadow-sm">Auto Source</span>
      </div>

      <div class="card-authors text-sm text-gray-600 mt-1 line-clamp-2">Author 1, Author 2, Author 3</div>
      <div class="card-abstract text-sm text-gray-700 leading-relaxed line-clamp-4 mt-2">A snippet of the paper's abstractâ€¦</div>
    </div>
    <div class="px-5 pb-5 mt-auto flex justify-end">
      <a class="card-open inline-flex items-center gap-1 text-sm font-semibold text-blue-600 hover:text-blue-800 transition" target="_blank">
        View PDF
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    </div>
  </div>
</div>

<div id="cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
  {% for p in papers %}
    {% set paper = p %}
    {% include "_paper_card.html" %}
  {% else %}
    <div class="text-gray-500 text-lg p-8 border border-dashed rounded-xl col-span-full">
      No papers yet. Select a folder or drop PDFs above to get started!
    </div>
  {% endfor %}
</div>

<script>
  const folderPicker = document.getElementById('folderPicker');
  const progressWrap = document.getElementById('progressWrap');
  const progressText = document.getElementById('progressText');
  const progressBar  = document.getElementById('progressBar');

  function setProgress(done, total, name) {
    const pct = total ? Math.round((done / total) * 100) : 0;
    if (progressText) progressText.textContent = `Uploading ${done}/${total}${name ? ' â€“ ' + name : ''}`;
    if (progressBar)  progressBar.style.width = pct + '%';
  }
  function showProgress(show) {
    if (!progressWrap) return;
    progressWrap.classList.toggle('hidden', !show);
  }

  // ðŸ‘‰ Replace grid with SSR-rendered HTML so card design is identical
  async function swapGridFromSSR(q) {
    const url = q ? `/?q=${encodeURIComponent(q)}` : '/';
    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newCards = doc.querySelector('#cards');
    const cardsDiv = document.getElementById('cards');
    if (newCards && cardsDiv) {
      cardsDiv.innerHTML = newCards.innerHTML;
      if (window.Alpine) Alpine.initTree(cardsDiv);
    }
  }

  async function liveSearch(q) {
    // Use the SSR swap so list always matches server template
    await swapGridFromSSR(q);
  }

  async function refreshCards() {
    const qInput = document.querySelector('input[name="q"]');
    const q = qInput ? qInput.value : '';
    await swapGridFromSSR(q);
  }

  // ðŸ“ Folder Upload Logic (unchanged)
  if (folderPicker) {
    folderPicker.addEventListener('change', async (e) => {
      const all = Array.from(e.target.files || []);
      const pdfs = all.filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      showProgress(true);
      setProgress(0, pdfs.length, '');

      let done = 0;
      for (const f of pdfs) {
        try {
          setProgress(done, pdfs.length, f.name);
          const fd = new FormData();
          fd.append('file', f);
          await fetch('/upload', { method: 'POST', body: fd });
          await refreshCards();
        } catch (err) {
          console.error('Upload failed:', err);
        } finally {
          done += 1;
          setProgress(done, pdfs.length, done < pdfs.length ? pdfs[done]?.name : '');
        }
      }

      setProgress(pdfs.length, pdfs.length, 'Done');
      setTimeout(async () => {
        showProgress(false);
        e.target.value = '';
        // Keep your hard refresh too if you like. SSR swap already updates the grid.
        await refreshCards();
      }, 800);
    });
  }

  // First load: ensure grid reflects current data via SSR (keeps look identical)
  document.addEventListener('DOMContentLoaded', async () => {
    const qInput = document.querySelector('input[name="q"]');
    const q = qInput ? qInput.value : '';
    await swapGridFromSSR(q);
  });
</script>
{% endblock %}