{% extends "base.html" %} {% block title %}PaperShelf Library{% endblock %} {%
block content %}

<!-- Top panel Â· Material 3 style (all features preserved) -->
<div class="mb-6">
  <div class="rounded-3xl bg-white/95 dark:bg-slate-900/80 shadow-lg ring-1 ring-slate-950/5 dark:ring-white/10 backdrop-blur supports-[backdrop-filter]:backdrop-blur">
    <div class="p-4 md:p-5">
      <div class="flex flex-col gap-4">

        <!-- Row: Search (filled text field) + Actions (icon buttons) -->
        <div class="flex items-center gap-3">
          <!-- Search (GET form) Â· M3 filled text field with leading icon -->
          <form method="get" class="relative flex-1 min-w-0">
            <label class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none">
              <svg class="w-5 h-5 text-slate-500 dark:text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </label>
            <input
              name="q"
              value="{{ q }}"
              placeholder="Search papers"
              class="w-full pl-10 pr-4 py-3 rounded-2xl bg-slate-100/90 dark:bg-slate-800/80 text-slate-900 dark:text-slate-100 placeholder:text-slate-500 dark:placeholder:text-slate-400 border border-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-600/60 focus:border-blue-500 transition"
              oninput="liveSearch(this.value)"
            />
          </form>

          <!-- Actions (icon buttons with state layer) -->
          <div class="flex items-center gap-2 shrink-0">
            <!-- Select Folder (label controls hidden input) -->
            <label for="folderPicker"
                   class="relative inline-flex items-center justify-center size-10 rounded-full text-blue-700 dark:text-sky-300 hover:bg-blue-600/10 dark:hover:bg-white/10 active:scale-[0.98] transition"
                   title="Select folder" aria-label="Select folder">
              <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l2 3h10a1 1 0 011 1v7a1 1 0 01-1 1H3V7z" />
              </svg>
            </label>
            <input id="folderPicker" type="file" webkitdirectory directory multiple hidden />

            <!-- Clean DB (POST) -->
            <form method="post" action="/dev/clean" class="shrink-0" title="Clean DB &amp; Files" aria-label="Clean DB &amp; Files">
              <button type="submit"
                class="relative inline-flex items-center justify-center size-10 rounded-full text-red-600 dark:text-red-400 border border-transparent hover:bg-red-600/10 dark:hover:bg-white/10 active:scale-[0.98] transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-3h4m-5 3h6" />
                </svg>
              </button>
            </form>
          </div>
        </div>

        <!-- Row: Progress (Material 3 linear indicator) -->
        <div id="progressWrap" class="hidden">
          <div class="flex flex-col gap-1">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2.5 min-w-0">
                <!-- Material 3 circular progress indicator (indeterminate) -->
                <span role="status" aria-live="polite" class="inline-flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-600 dark:text-sky-400 animate-spin" viewBox="0 0 48 48" fill="none" aria-hidden="true">
                    <!-- Track -->
                    <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-opacity="0.2" stroke-width="4" />
                    <!-- Active arc -->
                    <path d="M44 24a20 20 0 0 0-20-20" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
                  </svg>
                  <span class="sr-only">Uploadingâ€¦</span>
                </span>
                <span id="progressFile" class="truncate text-sm text-slate-700 dark:text-slate-200">Preparingâ€¦</span>
              </div>
              <span id="progressPct" class="text-xs font-semibold text-slate-500 dark:text-slate-400">0%</span>
            </div>
            <div class="h-1.5 w-full rounded-full bg-slate-200/90 dark:bg-slate-700/70 overflow-hidden">
              <div id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                   class="h-full rounded-full transition-[width] duration-300 bg-gradient-to-r from-blue-600 via-indigo-500 to-purple-500"
                   style="width:0%"></div>
            </div>
            <div class="text-[11px] leading-4 text-slate-500 dark:text-slate-400"><span id="progressCounter">0/0</span></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Cards grid -->
<div id="cards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
  {% for p in papers %} {% set paper = p %} {% include "_paper_card.html" %} {%
  else %}

  <!-- Drag & Drop only when there are no papers -->
  <div
    id="drop"
    x-data
    @dragover.prevent.delay.100="$el.classList.add('bg-blue-50','border-blue-500')"
    @dragleave.prevent.delay.100="$el.classList.remove('bg-blue-50','border-blue-500')"
    @drop.prevent="
           $el.classList.remove('bg-blue-50','border-blue-500');
           const files = $event.dataTransfer.files;
           for (const f of files) {
             if (!f.name.toLowerCase().endsWith('.pdf')) continue;
             const fd = new FormData();
             fd.append('file', f);
             fetch('/upload', { method:'POST', body:fd }).then(() => refreshCards());
           }"
    class="col-span-full mb-6 p-8 text-center border-4 border-dashed rounded-2xl border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-lg text-slate-600 dark:text-slate-300 transition"
  >
    Drag & drop <strong>PDF(s)</strong> here to add ðŸ“¥
  </div>

  <div
    class="text-slate-500 dark:text-slate-300 text-lg p-8 border border-dashed border-slate-300 dark:border-slate-700 rounded-xl col-span-full text-center"
  >
    No papers yet. Select a folder or drop PDFs above to get started!
  </div>
  {% endfor %}
</div>

<!-- Global Drag & Drop Overlay (appears on drag, hidden otherwise) -->
<div id="dropOverlay"
     class="hidden fixed inset-0 z-40 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center">
  <div class="rounded-2xl border-2 border-dashed border-white/50 p-10 text-center text-white max-w-lg mx-auto">
    <div class="text-2xl font-semibold mb-2">Drop PDF(s) to Upload</div>
    <div class="text-sm opacity-80">Release to start uploading. Non-PDF files will be ignored.</div>
  </div>
</div>

<script>
  const folderPicker = document.getElementById('folderPicker');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar  = document.getElementById('progressBar');

  function setProgress(done, total, name) {
    const pct = total ? Math.round((done / total) * 100) : 0;
    if (progressBar) {
      progressBar.style.width = pct + '%';
      progressBar.setAttribute('aria-valuenow', String(pct));
      progressBar.setAttribute('aria-valuemin', '0');
      progressBar.setAttribute('aria-valuemax', '100');
      progressBar.setAttribute('role', 'progressbar');
    }

    const pctEl = document.getElementById('progressPct');
    if (pctEl) pctEl.textContent = pct + '%';

    const counterEl = document.getElementById('progressCounter');
    if (counterEl) counterEl.textContent = `${done}/${total}`;

    const fileEl = document.getElementById('progressFile');
    if (fileEl) fileEl.textContent = name || '';
  }
  function showProgress(show) {
    if (!progressWrap) return;
    progressWrap.classList.toggle('hidden', !show);
  }

  async function swapGridFromSSR(q) {
    const url = q ? `/?q=${encodeURIComponent(q)}` : '/';
    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newCards = doc.querySelector('#cards');
    const cardsDiv = document.getElementById('cards');
    if (newCards && cardsDiv) {
      cardsDiv.innerHTML = newCards.innerHTML;
      if (window.Alpine) Alpine.initTree(cardsDiv);
    }
  }

  async function liveSearch(q) { await swapGridFromSSR(q); }
  async function refreshCards() {
    const q = (document.querySelector('input[name="q"]') || {}).value || '';
    await swapGridFromSSR(q);
  }

  // --- Drag & Drop helpers (global overlay) ---
  const dropOverlay = document.getElementById('dropOverlay');
  function showDrop(show) {
    if (!dropOverlay) return;
    dropOverlay.classList.toggle('hidden', !show);
  }

  async function handleDroppedFiles(fileList) {
    const files = Array.from(fileList || []);
    const pdfs  = files.filter(f => f.name.toLowerCase().endsWith('.pdf'));
    if (!pdfs.length) return;

    showProgress(true);
    setProgress(0, pdfs.length, '');

    let done = 0;
    for (const f of pdfs) {
      try {
        setProgress(done, pdfs.length, f.name);
        const fd = new FormData();
        fd.append('file', f);
        await fetch('/upload', { method: 'POST', body: fd });
        await refreshCards();
      } catch (err) {
        console.error('Upload failed:', err);
      } finally {
        done += 1;
        setProgress(done, pdfs.length, done < pdfs.length ? pdfs[done]?.name : '');
      }
    }

    setProgress(pdfs.length, pdfs.length, 'Done');
    setTimeout(async () => {
      showProgress(false);
      await refreshCards();
    }, 700);
  }

  if (folderPicker) {
    folderPicker.addEventListener('change', async (e) => {
      const all = Array.from(e.target.files || []);
      const pdfs = all.filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      showProgress(true);
      setProgress(0, pdfs.length, '');

      let done = 0;
      for (const f of pdfs) {
        try {
          setProgress(done, pdfs.length, f.name);
          const fd = new FormData();
          fd.append('file', f);
          await fetch('/upload', { method: 'POST', body: fd });
          await refreshCards();
        } catch (err) {
          console.error('Upload failed:', err);
        } finally {
          done += 1;
          setProgress(done, pdfs.length, done < pdfs.length ? pdfs[done]?.name : '');
        }
      }

      setProgress(pdfs.length, pdfs.length, 'Done');
      setTimeout(async () => {
        showProgress(false);
        e.target.value = '';
        await refreshCards();
      }, 800);
    });
  }

  // --- Global drag & drop events ---
  let dragCounter = 0; // to manage nested dragenter/dragleave
  ['dragenter','dragover'].forEach(evt => {
    document.addEventListener(evt, (e) => {
      // Ignore if coming from inputs or editable areas
      if ((e.target instanceof HTMLElement) && (e.target.closest('input, textarea, [contenteditable="true"]'))) return;
      e.preventDefault();
      e.stopPropagation();
      dragCounter++;
      showDrop(true);
    });
  });

  ['dragleave','drop'].forEach(evt => {
    document.addEventListener(evt, (e) => {
      if ((e.target instanceof HTMLElement) && (e.target.closest('input, textarea, [contenteditable="true"]'))) return;
      e.preventDefault();
      e.stopPropagation();
      if (evt === 'dragleave') {
        dragCounter = Math.max(0, dragCounter - 1);
        if (dragCounter === 0) showDrop(false);
      }
    });
  });

  document.addEventListener('drop', async (e) => {
    // If files are dropped anywhere on the page, upload PDFs
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
      showDrop(false);
      dragCounter = 0;
      await handleDroppedFiles(e.dataTransfer.files);
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const q = (document.querySelector('input[name="q"]') || {}).value || '';
    await swapGridFromSSR(q);
  });
</script>
{% endblock %}
