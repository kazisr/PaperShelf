{% extends "base.html" %} {% block title %}PaperShelf Library{% endblock %} {%
block content %}

<!-- Top panel (redesigned, all features preserved) -->
<div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/80 shadow-sm p-4 md:p-5 mb-6 backdrop-blur supports-[backdrop-filter]:backdrop-blur">
  <div class="flex flex-col gap-4">
    <!-- Row: Search + Actions -->
    <div class="flex items-center gap-3">
      <!-- Search (GET form) -->
      <form method="get" class="relative flex-1 min-w-0">
        <svg class="w-5 h-5 text-slate-400 dark:text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          name="q"
          value="{{ q }}"
          placeholder="Search by title or abstract..."
          class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 pl-10 pr-4 py-2.5 text-slate-800 dark:text-slate-100 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
          oninput="liveSearch(this.value)"
        />
      </form>

      <!-- Actions: Folder (label for #folderPicker) + Clean DB (POST form) -->
      <div class="flex items-center gap-2 shrink-0">
        <!-- Select Folder (icon-only button via label) -->
        <label for="folderPicker" class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-blue-600 hover:bg-blue-700 text-white shadow-sm cursor-pointer transition" title="Select Folder" aria-label="Select Folder">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l2 3h10a1 1 0 011 1v7a1 1 0 01-1 1H3V7z" />
          </svg>
        </label>
        <input id="folderPicker" type="file" webkitdirectory directory multiple hidden />

        <!-- Clean DB (icon-only POST) -->
        <form method="post" action="/dev/clean" class="shrink-0" title="Clean DB &amp; Files" aria-label="Clean DB &amp; Files">
          <button class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-red-500 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-3h4m-5 3h6" />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- Row: Progress (hidden by default; shown during uploads, compact modern UI) -->
    <div id="progressWrap" class="hidden w-full">
      <div class="flex items-center gap-3">
        <div class="relative flex-1 w-full">
          <!-- Header row: spinner + filename (left) and percentage (right) -->
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2 min-w-0">
              <!-- CSS spinner (no external icons) -->
              <span class="inline-block w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></span>
              <span id="progressFile" class="truncate text-sm text-slate-700 dark:text-slate-200">Preparingâ€¦</span>
            </div>
            <span id="progressPct" class="text-xs font-semibold text-slate-500 dark:text-slate-400">0%</span>
          </div>

          <!-- Slim progress bar -->
          <div class="h-1.5 w-full rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
            <div id="progressBar" class="h-full rounded-full transition-[width] duration-300 bg-gradient-to-r from-blue-500 to-indigo-500" style="width:0%"></div>
          </div>

          <!-- Counter (tiny text) -->
          <div class="mt-1 text-[10px] leading-4 text-slate-400 dark:text-slate-500">
            <span id="progressCounter">0/0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cards grid -->
<div id="cards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
  {% for p in papers %} {% set paper = p %} {% include "_paper_card.html" %} {%
  else %}

  <!-- Drag & Drop only when there are no papers -->
  <div
    id="drop"
    x-data
    @dragover.prevent.delay.100="$el.classList.add('bg-blue-50','border-blue-500')"
    @dragleave.prevent.delay.100="$el.classList.remove('bg-blue-50','border-blue-500')"
    @drop.prevent="
           $el.classList.remove('bg-blue-50','border-blue-500');
           const files = $event.dataTransfer.files;
           for (const f of files) {
             if (!f.name.toLowerCase().endsWith('.pdf')) continue;
             const fd = new FormData();
             fd.append('file', f);
             fetch('/upload', { method:'POST', body:fd }).then(() => refreshCards());
           }"
    class="col-span-full mb-6 p-8 text-center border-4 border-dashed rounded-2xl border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-lg text-slate-600 dark:text-slate-300 transition"
  >
    Drag & drop <strong>PDF(s)</strong> here to add ðŸ“¥
  </div>

  <div
    class="text-slate-500 dark:text-slate-300 text-lg p-8 border border-dashed border-slate-300 dark:border-slate-700 rounded-xl col-span-full text-center"
  >
    No papers yet. Select a folder or drop PDFs above to get started!
  </div>
  {% endfor %}
</div>

<script>
  const folderPicker = document.getElementById('folderPicker');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar  = document.getElementById('progressBar');

  function setProgress(done, total, name) {
    const pct = total ? Math.round((done / total) * 100) : 0;
    if (progressBar) {
      progressBar.style.width = pct + '%';
      progressBar.setAttribute('aria-valuenow', String(pct));
      progressBar.setAttribute('aria-valuemin', '0');
      progressBar.setAttribute('aria-valuemax', '100');
      progressBar.setAttribute('role', 'progressbar');
    }

    const pctEl = document.getElementById('progressPct');
    if (pctEl) pctEl.textContent = pct + '%';

    const counterEl = document.getElementById('progressCounter');
    if (counterEl) counterEl.textContent = `${done}/${total}`;

    const fileEl = document.getElementById('progressFile');
    if (fileEl) fileEl.textContent = name || '';
  }
  function showProgress(show) {
    if (!progressWrap) return;
    progressWrap.classList.toggle('hidden', !show);
  }

  async function swapGridFromSSR(q) {
    const url = q ? `/?q=${encodeURIComponent(q)}` : '/';
    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newCards = doc.querySelector('#cards');
    const cardsDiv = document.getElementById('cards');
    if (newCards && cardsDiv) {
      cardsDiv.innerHTML = newCards.innerHTML;
      if (window.Alpine) Alpine.initTree(cardsDiv);
    }
  }

  async function liveSearch(q) { await swapGridFromSSR(q); }
  async function refreshCards() {
    const q = (document.querySelector('input[name="q"]') || {}).value || '';
    await swapGridFromSSR(q);
  }

  if (folderPicker) {
    folderPicker.addEventListener('change', async (e) => {
      const all = Array.from(e.target.files || []);
      const pdfs = all.filter(f => f.name.toLowerCase().endsWith('.pdf'));
      if (!pdfs.length) return;

      showProgress(true);
      setProgress(0, pdfs.length, '');

      let done = 0;
      for (const f of pdfs) {
        try {
          setProgress(done, pdfs.length, f.name);
          const fd = new FormData();
          fd.append('file', f);
          await fetch('/upload', { method: 'POST', body: fd });
          await refreshCards();
        } catch (err) {
          console.error('Upload failed:', err);
        } finally {
          done += 1;
          setProgress(done, pdfs.length, done < pdfs.length ? pdfs[done]?.name : '');
        }
      }

      setProgress(pdfs.length, pdfs.length, 'Done');
      setTimeout(async () => {
        showProgress(false);
        e.target.value = '';
        await refreshCards();
      }, 800);
    });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const q = (document.querySelector('input[name="q"]') || {}).value || '';
    await swapGridFromSSR(q);
  });
</script>
{% endblock %}
